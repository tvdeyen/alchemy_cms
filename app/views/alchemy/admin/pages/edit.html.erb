<% content_for(:title) { @page.name } %>

<% content_for(:main_menu_style) { 'collapsed-menu' } %>

<% content_for(:toolbar) do %>
<div class="toolbar_buttons">
  <div class="button_with_label">
    <%= form_tag alchemy.unlock_admin_page_path(@page, redirect_to: @layoutpage ? alchemy.admin_layoutpages_path : alchemy.admin_pages_path), id: 'unlock_page_form' do %>
      <button class="icon_button" title="<%= Alchemy.t(:explain_unlocking) %>" data-alchemy-hotkey="alt+x">
        <%= render_icon('sign-out-alt', transform: 'flip-horizontal') %>
      </button>
      <label><%= Alchemy.t(:unlock_page) %></label>
    <% end %>
  </div>
  <div class="toolbar_spacer"></div>
  <% unless @page.layoutpage? %>
  <div class="button_with_label">
    <%= form_tag alchemy.visit_admin_page_path(@page), id: 'visit_page_form' do %>
      <button class="icon_button" title="<%= Alchemy.t('Visit page') %>">
        <%= render_icon('external-link-alt') %>
      </button>
      <label><%= Alchemy.t("Visit page") %></label>
    <% end %>
  </div>
  <% end %>
  <div class="button_with_label">
    <%= link_to_dialog(
      render_icon('info-circle'),
      alchemy.info_admin_page_path(@page),
      {
        title: Alchemy.t(:page_infos),
        size: '520x320'
      },
      {
        class: 'icon_button',
        'data-alchemy-hotkey' => 'alt+i'
      }
    ) %>
    <label><%= Alchemy.t(:page_infos) %></label>
  </div>
  <div class="button_with_label">
    <% if @page.layoutpage? %>
      <%= link_to_dialog(
        render_icon(:cog),
        alchemy.edit_admin_layoutpage_path(@page),
        {
          title: Alchemy.t(:edit_page_properties),
          size: '450x170'
        },
        class: :icon_button,
        title: Alchemy.t(:edit_page_properties),
        'data-alchemy-hotkey' => 'alt+e'
      ) %>
    <% else %>
      <%= link_to_dialog(
        render_icon(:cog),
        alchemy.configure_admin_page_path(@page),
        {
          title: Alchemy.t(:edit_page_properties),
          size: '450x680'
        },
        class: :icon_button,
        title: Alchemy.t(:edit_page_properties),
        'data-alchemy-hotkey' => 'alt+e'
      ) %>
    <% end %>
    <label><%= Alchemy.t(:page_properties) %></label>
  </div>
  <% if can?(:publish, @page) %>
    <div class="button_with_label">
      <%= form_tag alchemy.publish_admin_page_path(@page), id: 'publish_page_form' do %>
        <%= button_tag class: 'icon_button', title: Alchemy.t(:explain_publishing) do %>
          <%= render_icon('cloud-upload-alt') %>
        <% end %>
        <label><%= Alchemy.t("Publish page") %></label>
      <% end %>
    </div>
  <% end %>
  <% if @page.has_hint? %>
    <div class="toolbar_spacer"></div>
    <%= render_hint_for(@page) %>
  <% end %>
  <div class="toolbar_spacer"></div>
  <div class="select_with_label">
    <label><%= Alchemy.t(:preview_size) %></label>
    <%= select_tag 'preview_size',
      preview_sizes_for_select,
      class: 'alchemy_selectbox medium' %>
  </div>
  <div class="toolbar_spacer"></div>
  <div class="button_with_label">
    <%= link_to render_icon(:redo), nil, {
      title: Alchemy.t('Reload Preview'),
      class: 'icon_button',
      id: 'reload_preview_button'
    } %>
    <label><%= Alchemy.t('Reload Preview') %></label>
  </div>
</div>
<div class="toolbar_buttons right">
  <div class="button_with_label" id="element_window_button">
    <%= link_to render_icon(:bars), nil, {
      title: Alchemy.t(:hide_elements),
      class: 'icon_button'
    } %>
    <label><%= Alchemy.t(:hide_elements) %></label>
  </div>
</div>
<% end %>

<% content_for :javascript_includes do %>
  <meta name="turbolinks-cache-control" content="no-cache">
<% end %>

<div id="vue-app">
  <alchemy-preview-window
    url="<%= admin_page_path(@page) %>"
    left-menu-width="47"
    top-menu-height="75"
    elements-window-width="400"></alchemy-preview-window>
  <alchemy-elements-window
    url="<%= alchemy.api_elements_path(page_id: @page.id) %>"
    :page-id="<%= @page.id %>"
    :richtext-content-ids="<%= @page.richtext_contents_ids.to_json %>"
    top-menu-height="75"></alchemy-elements-window>
</div>

<% content_for :javascripts do %>
<% if Alchemy::Tinymce.custom_config_contents(@page).present? %>
  <%= render 'tinymce_custom_config' %>
<% end %>

<script type="text/javascript" charset="utf-8">
  Alchemy.eventBus = new Vue();
  Alchemy.vueInstance = new Vue({el: '#vue-app'});

  $(function() {
    $('#unlock_page_form, #visit_page_form, #publish_page_form').on('submit', function(event) {
      var not_dirty = Alchemy.checkPageDirtyness(this);
      if (!not_dirty) Alchemy.pleaseWaitOverlay(false);
      return not_dirty;
    });
    Alchemy.Sitemap.watchPagePublicationState();
    Alchemy.PageLeaveObserver();

    $('#preview_size').bind('open.selectBoxIt', function (e) {
      $('#top_menu').css('z-index', 5000);
    });

    $('#preview_size').bind('blur.selectBoxIt', function (e) {
      $('#top_menu').css('z-index', 30);
    });

    $('select#preview_size').on('change', function(e) {
      var width = this.value;
      if (this.value === 'auto') {
        Alchemy.resizePreview();
      } else {
        Alchemy.resizePreview(width);
      }
    });

    $(window).resize(function() {
      Alchemy.resizePreview();
      Alchemy.resizeElementsWindow();
    });
  });
</script>
<% end %>
